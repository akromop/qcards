<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <title>QCards</title>

  <!-- –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π viewport –¥–ª—è iPhone -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- iOS: –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="QCards">

  <!-- –ò–∫–æ–Ω–∫–∞ —è—Ä–ª—ã–∫–∞ -->
  <link rel="apple-touch-icon" href="icon-180.png">

  <style>
    :root {
      /* üü¢ –¶–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
      --bg-body: #050814;
      --bg-card: #0b0f1f;

      /* üü¢ –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ */
      --accent-pink: #ff4fbf;
      --accent-pink-hover: #ff6fd0;
      --accent-lilac: #b388ff;
      --accent-lilac-hover: #9b6cff;

      /* üü¢ –¶–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –±–æ—Ä–¥–µ—Ä–æ–≤ */
      --border-soft: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-subtle: rgba(255, 255, 255, 0.6);

      /* üü¢ –¢—ë–º–Ω–∞—è ¬´–ø—Ä–∏–∑—Ä–∞—á–Ω–∞—è¬ª –∫–Ω–æ–ø–∫–∞ */
      --btn-dark: #141827;
      --btn-dark-hover: #1a1f33;

      /* üü¢ –°–∫—Ä—É–≥–ª–µ–Ω–∏—è –∏ —Ç–µ–Ω—å */
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 999px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
    }

    .app {
      width: 100%;
      max-width: 100%;
      min-height: 100vh;
      margin: 0;
      padding: 40px 12px 40px;    /* üü¢ –æ–±—â–∏–µ –æ—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
      border-radius: 0;
      background:
        radial-gradient(circle at top left, rgba(255, 79, 191, 0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(179, 136, 255, 0.16), transparent 55%),
        var(--bg-card);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);

      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;         /* üü¢ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
      margin-bottom: 20px;        /* üü¢ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —à–∞–ø–∫–∏ –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    }

    header h1 {
      font-size: 30px;            /* üü¢ —Ä–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
      margin: 0;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 20px 0 0;           /* üü¢ ¬´–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞¬ª –º–µ–∂–¥—É h1 –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–º */
      font-size: 20px;            /* üü¢ —Ä–∞–∑–º–µ—Ä –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞ */
      color: var(--text-subtle);
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .screen {
      display: none;
      min-height: 250px;          /* üü† –≤—ã—Å–æ—Ç–∞ —Ä–∞–±–æ—á–µ–π –∑–æ–Ω—ã */
    }
    .screen.active {
      display: block;
    }

    /* –ö–ù–û–ü–ö–ò –í–´–ë–û–†–ê –†–ï–ñ–ò–ú–ê */
    .mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 18px;                  /* üü¢ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É Sp√∏rsm√•l / Overraskelse */
      margin: 10px 0 10px;        /* üü¢ –æ—Ç—Å—Ç—É–ø—ã —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É –±–ª–æ–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 40px 20px;         /* üü¢ –≤—ã—Å–æ—Ç–∞ –±–æ–ª—å—à–∏—Ö –∫–Ω–æ–ø–æ–∫ */
      font-size: 30px;            /* üü¢ —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ –∫–Ω–æ–ø–∫–∞—Ö */
      font-weight: 600;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: transform 0.06s ease, box-shadow 0.06s ease,
        background-color 0.08s ease, opacity 0.08s ease;
      will-change: transform;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: var(--accent-pink);
      color: #250815;
      box-shadow: 0 8px 20px rgba(255, 79, 191, 0.4);
    }

    .btn-primary:hover {
      background: var(--accent-pink-hover);
    }

    .btn-secondary {
      background: var(--accent-lilac);
      color: #1b1030;
      box-shadow: 0 8px 18px rgba(179, 136, 255, 0.45);
    }

    .btn-secondary:hover {
      background: var(--accent-lilac-hover);
    }

    .btn-ghost {
      padding: 6px 14px;
      font-size: 14px;
      border-radius: var(--radius-sm);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-subtle);
      border: 1px solid rgba(255, 255, 255, 0.08);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.07);
    }

    .btn-ghost.small-reset {
      padding: 10px 20px;         /* üü¢ —Ä–∞–∑–º–µ—Ä –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ –≤ —Ñ—É—Ç–µ—Ä–µ */
      font-size: 18px;
    }

    .btn-ghost:disabled {
      opacity: 0.45;              /* üü¢ disabled state */
      cursor: default;
    }

    .small-label {
      font-size: 18px;
      color: var(--text-subtle);
    }

    /* –ö–ê–†–¢–û–ß–ö–ê */
    .card {
      padding: 15px 15px 15px;
      border-radius: var(--radius-md);
      background: rgba(6, 9, 22, 0.9);
      border: 3px solid var(--border-soft);
      transition: border-color 0.08s ease, box-shadow 0.08s ease;
    }

    /* –†–∞–º–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏ */
    .card.card-from-spm {
      border-color: var(--accent-pink);
      box-shadow: 0 0 0 1px rgba(255, 79, 191, 0.35);
    }
    .card.card-from-overraskelse {
      border-color: var(--accent-lilac);
      box-shadow: 0 0 0 1px rgba(179, 136, 255, 0.35);
    }

    .card-type {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--text-subtle);
      display: flex;
      justify-content: space-between; /* —Ç–∏–ø —Å–ª–µ–≤–∞, TEST —Å–ø—Ä–∞–≤–∞ */
      align-items: center;
    }

    /* üü¢ –ü–ª–∞—à–∫–∞ —Å —Ç–∏–ø–æ–º, —Ü–≤–µ—Ç –º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å–∞–º–∏ pill-spm / pill-overraskelse */
    .type-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-main);
    }
    .type-pill-spm {
      background: var(--accent-pink);
      color: #250815;
    }
    .type-pill-overraskelse {
      background: var(--accent-lilac);
      color: #1b1030;
    }

    /* –ë–µ–π–¥–∂ TEST */
    .test-badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.06em;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      color: var(--text-subtle);
    }
    .test-badge.hidden {
      display: none;
    }

    .card-text {
      font-size: 30px;            /* üü¢ —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
      line-height: 1.55;
      margin-bottom: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 325px;          /* üü† –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ */
    }

    /* –ö–Ω–æ–ø–∫–∞ ¬´Tilbake¬ª ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–æ–π */
    .card-actions {
      width: 50%;
      margin: 18px auto 0;
      display: flex;
      justify-content: center;
    }

    .btn-back {
      min-width: 100px;
      padding-inline: 10px;
      font-size: 30px;
      font-weight: 600;
      background: #3a3f55;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(58, 63, 85, 0.45);
      border-radius: var(--radius-md);
    }
    .btn-back:hover {
      background: #464c66;
    }

    /* –§–£–¢–ï–†: Testmodus + Fjern + Kort i dag + Nullstill */
    .bottom-row {
      margin-top: 50px;          /* üü† —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–æ —Ñ—É—Ç–µ—Ä–∞ */
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      color: var(--text-subtle);
    }

    .bottom-row-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .testmode-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: var(--text-subtle);
    }

    .testmode-toggle input {
      width: 18px;
      height: 18px;
    }

    .bottom-row-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bottom-row span strong {
      color: var(--text-main);
      font-weight: 600;
    }

    @media (min-width: 900px) {
      .app {
        width: 520px;
        margin: 24px auto;
        border-radius: var(--radius-lg);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>QCards</h1>
      <!-- üü¢ —Ç–µ–∫—Å—Ç –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ -->
      <p id="header-sub">Klar for prat eller bare litt fun? Trykk p√• en knapp.</p>
    </header>

    <div class="content">
      <!-- –≠–∫—Ä–∞–Ω —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏ -->
      <main class="screen active" id="screen-home">
        <div class="mode-buttons">
          <button id="btn-spm" class="btn btn-primary">
            Sp√∏rsm√•l
          </button>
          <button id="btn-overraskelse" class="btn btn-secondary">
            Overraskelse
          </button>
        </div>
      </main>

      <!-- –≠–∫—Ä–∞–Ω —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π -->
      <main class="screen" id="screen-card">
        <div class="card" id="card-container">
          <div class="card-type">
            <span id="card-type-pill" class="type-pill">‚Äì</span>
            <span id="card-test-badge" class="test-badge hidden">TEST</span>
          </div>
          <div class="card-text" id="card-text">
            Laster kort ‚Ä¶
          </div>
        </div>
        <div class="card-actions">
          <button id="btn-back" class="btn btn-back">
            ‚Üê Tilbake
          </button>
        </div>
      </main>
    </div>

    <!-- –§—É—Ç–µ—Ä: Testmodus + Fjern + Kort i dag + Nullstill -->
    <div class="bottom-row">
      <div class="bottom-row-left">
        <label class="testmode-toggle">
          <input type="checkbox" id="chk-testmode" />
          <span>Testmodus</span>
        </label>
        <button id="btn-remove" class="btn-ghost small-reset" type="button" disabled>
          Fjern
        </button>
      </div>
      <div class="bottom-row-right">
        <span class="small-label">
          Kort i dag: <strong id="stats-count">‚Äì</strong>
        </span>
        <button id="btn-reset" class="btn-ghost small-reset" type="button">
          Nullstill
        </button>
      </div>
    </div>
  </div>

  <script>
    // üü¢ –í–°–¢–ê–í–¨ –°–í–û–ô WEB APP URL –ù–ò–ñ–ï
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxG4qwvJAu51QRaQgu9FvKnMb5Wi2NMHQK8mnSsRsFlogSElriOFXZ96uOuGwGF6yQ0qg/exec';

    const screenHome = document.getElementById('screen-home');
    const screenCard = document.getElementById('screen-card');

    const btnSpm = document.getElementById('btn-spm');
    const btnOverraskelse = document.getElementById('btn-overraskelse');
    const btnBack = document.getElementById('btn-back');
    const btnReset = document.getElementById('btn-reset');
    const btnRemove = document.getElementById('btn-remove');

    const chkTestmode = document.getElementById('chk-testmode');

    const cardContainer = document.getElementById('card-container');
    const cardTypePill = document.getElementById('card-type-pill');
    const cardTestBadge = document.getElementById('card-test-badge');
    const cardText = document.getElementById('card-text');
    const statsCountEl = document.getElementById('stats-count');
    const headerSub = document.getElementById('header-sub');

    let currentCard = null;
    let isTestMode = false; // —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ Testmodus

    function setScreen(name) {
      if (name === 'home') {
        screenHome.classList.add('active');
        screenCard.classList.remove('active');
        headerSub.style.display = 'block';

        currentCard = null;
        btnRemove.disabled = true;
      } else if (name === 'card') {
        screenCard.classList.add('active');
        screenHome.classList.remove('active');
        headerSub.style.display = 'none';
      }
    }

    async function callBackend(params) {
      const url = new URL(BACKEND_URL);
      if (params) {
        Object.keys(params).forEach(key => {
          url.searchParams.set(key, params[key]);
        });
      }

      const res = await fetch(url.toString(), { cache: 'no-store' });
      if (!res.ok) {
        throw new Error('HTTP ' + res.status);
      }
      return res.json();
    }

    function setCardVisualMode(mode) {
      cardContainer.classList.remove('card-from-spm', 'card-from-overraskelse');
      cardTypePill.classList.remove('type-pill-spm', 'type-pill-overraskelse');

      if (mode === 'spm') {
        cardContainer.classList.add('card-from-spm');
        cardTypePill.classList.add('type-pill-spm');
      } else if (mode === 'overraskelse') {
        cardContainer.classList.add('card-from-overraskelse');
        cardTypePill.classList.add('type-pill-overraskelse');
      }
    }

    async function loadCard(mode) {
      try {
        cardText.textContent = 'Laster kort ‚Ä¶';
        setCardVisualMode(mode);
        setScreen('card');

        const data = await callBackend({
          mode,
          test: isTestMode ? '1' : '0'   // ‚Üê –ø–µ—Ä–µ–¥–∞—ë–º test-—Ñ–ª–∞–≥ –≤ backend
        });

        if (!data.ok) {
          cardTypePill.textContent = 'Feil';
          cardTestBadge.classList.add('hidden');
          cardText.textContent = data.error || 'Ukjent feil';
          currentCard = null;
          btnRemove.disabled = true;
          return;
        }

        cardTypePill.textContent = data.type || '‚Äì';

        // TEST –±–µ–π–¥–∂
        if (data.test === true) {
          cardTestBadge.classList.remove('hidden');
        } else {
          cardTestBadge.classList.add('hidden');
        }

        cardText.textContent = data.text || '';

        // –í —Ç–µ—Å—Ç-—Ä–µ–∂–∏–º–µ Fjern –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –º–æ–∂–µ—Ç –≤—ã–∫–ª—é—á–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É,
        // —Ç–∞–∫ —á—Ç–æ currentCard –∑–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ–≥–¥–∞
        currentCard = {
          type: data.type,
          id: data.id
        };
        btnRemove.disabled = false;

        // –°—á—ë—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ù–ï —Ç–µ—Å—Ç-—Ä–µ–∂–∏–º
        if (!isTestMode) {
          updateStats();
        }
      } catch (err) {
        cardTypePill.textContent = 'Feil';
        cardTestBadge.classList.add('hidden');
        cardText.textContent = 'Kunne ikke hente kort. Pr√∏v igjen.';
        console.log(err);
        currentCard = null;
        btnRemove.disabled = true;
      }
    }

    async function updateStats() {
      try {
        const data = await callBackend({ mode: 'stats' });
        if (data.ok && typeof data.count === 'number') {
          statsCountEl.textContent = data.count;
        }
      } catch (err) {
        console.log('stats error', err);
      }
    }

    async function resetToday() {
      try {
        const prevText = btnReset.textContent;
        btnReset.textContent = '...';
        btnReset.disabled = true;

        await callBackend({ mode: 'reset' });
        await updateStats();
      } catch (err) {
        console.log('reset error', err);
      } finally {
        btnReset.textContent = 'Nullstill';
        btnReset.disabled = false;
      }
    }

    async function removeCurrentCard() {
      try {
        if (!currentCard || !currentCard.type || currentCard.id === undefined || currentCard.id === null) {
          return;
        }

        const prevText = btnRemove.textContent;
        btnRemove.textContent = '...';
        btnRemove.disabled = true;

        await callBackend({
          mode: 'remove',
          type: currentCard.type,
          id: String(currentCard.id)
        });

        currentCard = null;
      } catch (err) {
        console.log('remove error', err);
      } finally {
        btnRemove.textContent = 'Fjern';
        btnRemove.disabled = true;
      }
    }

    // –°–æ–±—ã—Ç–∏—è
    btnSpm.addEventListener('click', () => loadCard('spm'));
    btnOverraskelse.addEventListener('click', () => loadCard('overraskelse'));
    btnBack.addEventListener('click', () => setScreen('home'));
    btnReset.addEventListener('click', resetToday);
    btnRemove.addEventListener('click', removeCurrentCard);

    // –ß–µ–∫–±–æ–∫—Å test-—Ä–µ–∂–∏–º–∞
    chkTestmode.addEventListener('change', (e) => {
      isTestMode = e.target.checked;
    });

    setScreen('home');
    updateStats();
  </script>
</body>
</html>
